#!/bin/bash
cd "$(dirname "$0")"

res_folder="/tmp/concordbft/results/clients"

run_config() {
  echo "Making sure no previous replicas are up..."
  killall skvbc_replica
  killall skvbc_client

  echo "Running replica 1..."
  ../TesterReplica/skvbc_replica -k setA_replica_ -i 0 &
  echo "Running replica 2..."
  ../TesterReplica/skvbc_replica -k setA_replica_ -i 1 &
  echo "Running replica 3..."
  ../TesterReplica/skvbc_replica -k setA_replica_ -i 2 &
  echo "Running replica 4..."
  ../TesterReplica/skvbc_replica -k setA_replica_ -i 3 &

  echo "Sleeping for 2 seconds"
  sleep 2

  NUM_OF_CLIENTS=${1}
  F=${2}
  C=${3}
  NUM_OF_REQUESTS=${4}
  FIRST_CLIENT_ID=${5}
  RES_FOLDER=${6}
  pids=[]
  for i in $(seq 0 $((NUM_OF_CLIENTS - 1))); do
    echo "Running client ${i}! (params: f=${F} ; c=${C} ; requests=${NUM_OF_REQUESTS} ; id=$((i + FIRST_CLIENT_ID)))"
    mkdir -p "${res_folder}/$((i + FIRST_CLIENT_ID))"
    time ../TesterClient/skvbc_client -f "${F}" -c "${C}" -p "${NUM_OF_REQUESTS}" -i $((i + FIRST_CLIENT_ID)) &
    pids[${i}]=$!
  done
  for pid in ${pids[*]}; do
      wait $pid
  done

  for i in $(seq 0 $((NUM_OF_CLIENTS - 1))); do
    sed -i -e "s/^/${NUM_OF_CLIENTS},/" "${res_folder}/$((i + FIRST_CLIENT_ID))/summary.csv"
    cat "${res_folder}/$((i + FIRST_CLIENT_ID))/summary.csv" >> "${RES_FOLDER}/results.csv"
    sed -i -e "s/^/${NUM_OF_CLIENTS},/" "${res_folder}/$((i + FIRST_CLIENT_ID))/summary1.csv"
    cat "${res_folder}/$((i + FIRST_CLIENT_ID))/summary1.csv" >> "${RES_FOLDER}/results1.csv"
  done

  echo "Finished!"
  # Cleaning up
  killall skvbc_replica
  killall skvbc_client
}

run_all() {
  rm -r -f ${res_folder}
  START=${1}
  END=${2}
  STEP=${3}
  F=${4}
  C=${5}
  NUM_OF_REQUESTS=${6}
  FIRST_CLIENT_ID=${7}
  now=$(date +"%m%d%Y:%H%M%S")
  RES_FOLDER="${res_folder}/../${NUM_OF_REQUESTS}_${END}/${now}"
  mkdir -p "${RES_FOLDER}"
  for i in $(seq "${START}" "${STEP}" "${END}"); do
    run_config "${i}" "${F}" "${C}" "${NUM_OF_REQUESTS}" "${FIRST_CLIENT_ID}" "${RES_FOLDER}"
  done
  sed -i "1s/^/clients,0,1.000000,2.000000,3.000000,4.000000,5.000000,6.000000,7.000000,8.000000,9.000000,10.000000,12.000000,14.000000,16.000000,18.000000,20.000000,25.000000,30.000000,35.000000,40.000000,45.000000,50.000000,60.000000,70.000000,80.000000,90.000000,100.000000,120.000000,140.000000,160.000000,180.000000,200.000000,250.000000,300.000000,350.000000,400.000000,450.000000,500.000000,600.000000,700.000000,800.000000,900.000000,1000.000000,1200.000000,1400.000000,1600.000000,1800.000000,2000.000000,2500.000000,3000.000000,3500.000000,4000.000000,4500.000000,5000.000000,6000.000000,7000.000000,8000.000000,9000.000000,10000.000000,12000.000000,14000.000000,16000.000000,18000.000000,20000.000000,25000.000000,30000.000000,35000.000000,40000.000000,45000.000000,50000.000000,60000.000000,70000.000000,80000.000000,90000.000000,100000.000000,120000.000000,140000.000000,160000.000000,180000.000000,200000.000000,250000.000000,300000.000000,350000.000000,400000.000000,450000.000000,500000.000000,600000.000000,700000.000000,800000.000000,900000.000000,1000000.000000,1200000.000000,1400000.000000,1600000.000000,1800000.000000,2000000.000000,2500000.000000,3000000.000000,3500000.000000,4000000.000000,4500000.000000,5000000.000000,6000000.000000,7000000.000000,8000000.000000,9000000.000000,10000000.000000,12000000.000000,14000000.000000,16000000.000000,18000000.000000,20000000.000000,25000000.000000,30000000.000000,35000000.000000,40000000.000000,45000000.000000,50000000.000000,60000000.000000,70000000.000000,80000000.000000,90000000.000000,100000000.000000,120000000.000000,140000000.000000,160000000.000000,180000000.000000,200000000.000000,250000000.000000,300000000.000000,350000000.000000,400000000.000000,450000000.000000,500000000.000000,600000000.000000,700000000.000000,800000000.000000,900000000.000000,1000000000.000000,1200000000.000000,1400000000.000000,1600000000.000000,1800000000.000000,2000000000.000000,2500000000.000000,3000000000.000000,3500000000.000000,4000000000.000000,4500000000.000000,5000000000.000000,6000000000.000000,7000000000.000000,8000000000.000000,9000000000.000000\n/" "${RES_FOLDER}/results.csv"
  sed -i "1s/^/clients,cid,size,min,q1,median,q3,max,avg,std,time\n/" "${RES_FOLDER}/results1.csv"
  rm -r -f ${res_folder}

}

for i in $(seq 0 0); do
  run_all 8 8 1 1 0 21 4
  # run_all 8 8 1 1 0 10 4
done
